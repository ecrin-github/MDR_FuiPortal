@page "/Search"
@inject HttpClient Http
@using MDR_FuiPortal.Client.SearchPage.InputComponents
@using MDR_FuiPortal.Client.SearchPage.ResultComponents
@using System.Text.RegularExpressions;
@using System.Text.Json;

<PageTitle>MDR Search</PageTitle>

<TopBarSearch onFiltersBarVisibilityChanged="ChangeFiltersBarVisibility" />

<div id="body-outer">
    <div id="body-main">

        @if (filtersBarShowing)
        {
            <div id="left-bar">
                <div id="filters-container">
                    <FluentDesignSystemProvider FillColor="#ecedee">
                        <FluentAccordion>
                            <FluentAccordionItem Heading="By Type" Style="font-size: 1rem; color: var(--txt-emph-colour)">
                                <CheckGroupType OnFeedbackChange="updateTypeFBack" OnSQLChange="updateTypeSQL" />
                            </FluentAccordionItem>
                            <FluentAccordionItem Heading="By Status" Style="font-size: 1rem; color: var(--txt-emph-colour)">
                                <CheckGroupStatus OnFeedbackChange="updateStatusFBack" OnSQLChange="updateStatusSQL" />
                            </FluentAccordionItem>
                            <FluentAccordionItem Heading="By Start Year" Style="font-size: 1rem; color: var(--txt-emph-colour)">
                                <YearSelection OnFeedbackChange="updateYearFBack" OnSQLChange="updateYearSQL" />
                            </FluentAccordionItem>
                            <FluentAccordionItem Heading="By Location" Style="font-size: 1rem; color: var(--txt-emph-colour)">
                                <CountrySelection onListChanged="updateCountryList" />
                            </FluentAccordionItem>
                            <FluentAccordionItem Heading="By Linked Object" Style="font-size: 1rem; color: var(--txt-emph-colour)">
                                <CheckGroupObject OnFeedbackChange="updateObjectFBack" OnSQLChange="updateObjectSQL" />
                            </FluentAccordionItem>
                        </FluentAccordion>
                    </FluentDesignSystemProvider>

                    <div class="filter-expln">
                        <p class="small-text small-text-expanded">
                            <b>N.B.</b>The two filters below only apply to interventional studies (= clinical trials).<br /><br />
                            If included in a query the results will be drawn <b><i>only</i></b> from interventional studies.
                        </p>
                    </div>

                    <FluentDesignSystemProvider FillColor="#ecedee">
                        <FluentAccordion>
                            <FluentAccordionItem Heading="By Phase" Style="font-size: 1rem; color: var(--txt-emph-colour)">
                                <CheckGroupPhase OnFeedbackChange="updatePhaseFBack" OnSQLChange="updatePhaseSQL" />
                            </FluentAccordionItem>
                            <FluentAccordionItem Heading="By Allocation" Style="font-size: 1rem; color: var(--txt-emph-colour)">
                                <CheckGroupAlloc OnFeedbackChange="updateAllocFBack" OnSQLChange="updateAllocSQL"/>
                            </FluentAccordionItem>
                        </FluentAccordion>
                    </FluentDesignSystemProvider>
                </div>
            </div>
        }

        <div id="middle-bar">

            <div id="fixed-top">   <!-- Fixed area at top-->
                <div id="search-bar">
                    <div id="search-type">
                        <div class="search-label-container">
                            <p class="search-label normal-blue-text">Search Type</p>
                        </div>
                        <div id="search-type-combo" >
                            <MDRComboBox idOptions="searchOptions" 
                             HandleSelectedOptionChanged="SearchOptionChanged"></MDRComboBox>
                        </div>
                    </div>

                    @if (searchType == 2)
                    {
                        <div id="search-subtype">
                            <div class="search-label-container">
                                <p class="search-label normal-blue-text">ID Type</p>
                            </div>
                            <div id="id-type-combo">
                                <MDRComboBox idOptions="idOptions"
                                  HandleSelectedOptionChanged="idOptionChanged"></MDRComboBox>
                            </div>
                        </div>
                    }

                    <div id="search-params">
                         <div class="search-label-container">
                            <p class="search-label normal-blue-text">@paramsLabelText</p>
                        </div>
                        <div id="params-text">
                            <input type="text" @bind="@searchParamsValue" @bind:event="oninput"
                                               style="width: 100%;" />
                        </div>
                    </div>
                </div>
                           
                <div id="switch-area">
                    <ClearButton id="ClearFilters" Caption="Clear Filters" onClicked="ClearFilters" />
                    <div id="small-switch-spacer"></div>
                    <ClearButton id="ClearSearch" Caption="Clear Search" onClicked="ClearSearch" />
                    <div id="switch-spacer"></div>
                    <div id="agg-switch" class="small-text no-wrap-text">
                        <FluentSwitch @bind-Value=aggregateSearches style="margin-inline-end: 12px;">Aggregate Results</FluentSwitch>
                    </div>
                    <div id="switch-spacer"></div>
                    <div id="tt-switch" class="small-text no-wrap-text">
                        <FluentSwitch @bind-Value=searchInTTs style="margin-inline-end: 12px;">Search in Titles and Topics</FluentSwitch>
                    </div>
                    <div id="cond-switch" class="small-text no-wrap-text">
                        <FluentSwitch @bind-Value=searchInConds style="margin-inline-end: 12px;">Search in Conditions</FluentSwitch>
                    </div>
                </div>

                <div id="feedback">
                    <div id="fb-container">
                        <p class="small-text-italic">
                            <span>This box visible during development only <br /></span>
                            @if (searchType == 1)
                            {
                                <span>
                                    KEY WORDS SEARCH, using @searchParamsValue, in @scope_fback; <br />
                                    FILTER(S): @filter_fback
                                </span>
                            }
                            @if (searchType == 2)
                            {
                                <span>ID SEARCH, using type: @idType (@idText), ID: @searchParamsValue</span>
                            }
                            @if (searchType == 3)
                            {
                                <span>PMID SEARCH, using @searchParamsValue</span>
                            }
                        </p>
                    </div>
                    <div id="sql-container">
                        <p class="small-text-italic">
                            <span>This box visible during development only <br /></span>
                            @if (searchType == 1)
                            {
                                <span>
                                    @search_url_fb <br />
                                    FILTER(S): @filter_sql
                                </span>
                            }
                            @if (searchType == 2)
                            {
                                <span>@search_url</span>
                            }
                            @if (searchType == 3)
                            {
                                <span>@search_url</span>
                            }
                        </p>
                    </div>
                </div>

                <div id="results-heading">
                    <div id="results-found">
                        <p class="small-text no-wrap-text">@rec_num_indicator</p>
                    </div>
                    <div id="results-spacer"> </div>
                    <div id="page-control">
                        <PageControl total_recs=rec_num ObtainRange="ShowRange" @ref="pagecon"/>
                    </div>
                </div>
            </div>

            <div id="fixed-results-container">
                <SpinLoader IsLoading="isLoading" IsFaulted="isEmpty">
                    <LoadingTemplate>
                        <div style="height:100px; margin-top:3rem;">
                            <Circle Color="royalblue" Size="60px" Center="true" />
                        </div>
                    </LoadingTemplate>
                    <ContentTemplate>
                        <div id="results-list">         <!-- Scrolling area -->
                            <FluentDesignSystemProvider FillColor="#fdfeff">     <!-- was #ecedee -->
                            @if (@PageSet is not null)
                            {   
                                <FluentAccordion>
                                    <PageContents Contents=@PageSet />
                                </FluentAccordion>
                            }
                            </FluentDesignSystemProvider>
                        </div>
                    </ContentTemplate>
                    <FaultedContentTemplate>
                        <div style="height:100px; margin-top:3rem;">
                            <p class="normal-blue-text" style="text-align: center; font-style: italic;">No records were found matching these search criteria</p>
                        </div>
                    </FaultedContentTemplate>
                </SpinLoader>
            </div>
        </div>

        <div id="right-bar">
            <SearchButton id="SearchButton" Caption="Search" onClicked="Search" />
        </div>
    </div>
</div>

@code {

    List<string>? BaseSet;
    List<string>? BucketSet;
    List<string>? ShowSet = null;
    List<string>? PageSet = null;
    PageControl? pagecon;

    int rec_num;
    int num_pages;
    int num_recs_per_page = 10;
    string rec_num_indicator = "No search yet run";
    int current_page = 1;
    string page_indicator = "";
    string search_url_stem = "api/Study";
    string search_url = "";
    string search_url_fb = "";

    string? searchText;
    int searchType = 1;
    string? idText;
    int? idType = 1;
    string? searchParamsValue;
    string paramsLabelText = "Parameters";
    bool SearchPossible = false;
    string processedPars = "";

    bool aggregateSearches = false;
    bool searchInTTs = true;
    bool searchInConds = true;
    int search_scope = 3;

    FilterParams currentFP = new FilterParams();
    FilterParams? originalFP;
    string filter_fback = "";
    string filter_sql = "";

    string type_fback = "";
    string status_fback = "";
    string year_fback = "";
    string country_fback = "";
    string object_fback = "";
    string phase_fback = "";
    string alloc_fback = "";
    string scope_fback = "";

    bool filtersBarShowing = true;

    private Dictionary<string, string> roman_suffixes = default!;

    private void ChangeFiltersBarVisibility(bool visibility)
    {
        filtersBarShowing = visibility;
    }

    bool isLoading = false;
    bool isEmpty = false;

    private async Task Search()
    {
        isLoading = true;
        isEmpty = false;
        rec_num_indicator = "Searching... ";

        if (searchType == 1)
        {
            search_scope = searchInTTs ? 1 : 0;
            search_scope += searchInConds ? 2 : 0;
            int page_size = pagecon?.recs_per_page ?? 10;

            processedPars = ProcessSearchParams(searchParamsValue);
            bool allow_search = true;

            if (processedPars == "ALL STUDIES")
            {
                allow_search = AllowNoTermsSearch();
                if (!allow_search)
                {
                    // post some sort of message
                }
            }

            if (allow_search)
            {
                BaseSet = new List<string>();
                int running_total = 0;
                if (pagecon is not null)
                {
                    pagecon.old_num_recs = 0;   // reset the page control's property
                }
                bool baseset_has_1000 = false;
                int bucket = 1;

                while (!baseset_has_1000 && bucket <= 20)
                {
                    int results_needed_for_baseset = 1000 - running_total;
                    SearchParams sp = new SearchParams(search_scope, processedPars, bucket, false, currentFP);
                    string spj = JsonSerializer.Serialize(sp);
                    search_url = $"{search_url_stem}/BySearch/{spj}/";
                    BucketSet = await Http.GetFromJsonAsync<List<string>>(search_url);

                    if (BucketSet?.Any() == true)
                    {
                        if (BucketSet.Count == 1 && BucketSet[0] == "null result")
                        {
                            // do nothing - null indicator returned
                        }
                        else
                        {
                            if (BucketSet.Count > results_needed_for_baseset)
                            {
                                BaseSet.AddRange(BucketSet.Take(results_needed_for_baseset));
                            }
                            else
                            {
                                BaseSet.AddRange(BucketSet);
                            }
                            int baseset_num = BaseSet.Count;

                            baseset_has_1000 = baseset_num == 1000;
                            running_total += BucketSet.Count;  // may be over 1000
                        }
                    }

                    UpdateIndicator(running_total, bucket, BaseSet.Count);
                    bucket++;
                }

                // Display if we have reached a 1000 records or done all 20 bucket searches

                if (baseset_has_1000 || bucket > 20)
                {
                    ShowSet = BaseSet; // for now - i.e. no in memory filters applied
                    rec_num = baseset_has_1000 ? 1000 : ShowSet.Count;
                    StateHasChanged();
                    await DoRemainingBuckets(bucket, running_total);
                }
            }
        }
        else
        {
            if (searchType == 2)
            {

                search_url = $"{search_url_stem}/ByRegId/{idType}/{searchParamsValue}";
                BaseSet = await Http.GetFromJsonAsync<List<string>>(search_url);
            }

            if (searchType == 3)
            {
                string? pmid = searchParamsValue;
                if (pmid is null || !int.TryParse(pmid, out int _))
                {
                    string fb_message = "The PMID input must be an integer";

                    // need some sort of message
                    // saying this is not valid
                }
                else
                {
                    search_url = $"{search_url_stem}/ByPMID/{searchParamsValue}";
                    BaseSet = await Http.GetFromJsonAsync<List<string>>(search_url);
                }
            }


            if (BaseSet?.Any() == true)
            {

                if (BaseSet.Count == 1 && BaseSet[0] == "null result")
                {
                    // post a 'none found message somewhere
                    rec_num_indicator = "No records found";
                    isEmpty = true;
                }
                else
                {
                    // if filter(s) set - apply filter using linq

                    if (pagecon is not null)
                    {
                        pagecon.old_num_recs = 0;   // reset the page control's property
                    }

                    ShowSet = BaseSet;  // for now, no filters!
                    UpdateIndicator(ShowSet.Count);

                    // setting rec_num will trigger the page control
                    // to set up the initial page contents call, 1 to n
                    // After that the page control's buttons will get the
                    // relevant portion of the 'show set'
                }

            }
        }
        isLoading = false;
    }


    private async Task DoRemainingBuckets(int bucket, int running_total)
    {
        while (bucket <= 20)
        {
            SearchParams sp = new SearchParams(search_scope, processedPars, bucket, true, currentFP);
            string spj = JsonSerializer.Serialize(sp);
            search_url = $"{search_url_stem}/BySearch/{spj}/";
            BucketSet = await Http.GetFromJsonAsync<List<string>>(search_url);

            if (BucketSet?.Any() == true)
            {
                if (BucketSet.Count == 1 && BucketSet[0].StartsWith("count:"))
                {
                    // get the count of records for this bucket
                    string count_string = BucketSet[0][6..].Trim();
                    if (int.TryParse(count_string, out int bucket_num))
                    {
                        running_total += bucket_num;
                    }
                }
            }

            UpdateIndicator(running_total, bucket, BaseSet!.Count);
            bucket++;
        }
    }


    private bool AllowNoTermsSearch()
    {
        // All this neds checking properly

        if (currentFP is null || currentFP.has_any == false)
        {
            return false;
        }

        if (!string.IsNullOrEmpty(currentFP.start_year) || !string.IsNullOrEmpty(currentFP.countries))
        {
            return false;
        }

        if (!string.IsNullOrEmpty(currentFP.study_type) 
        && (currentFP.study_type.Contains("11") || currentFP.study_type.Contains("12")))
        {
            return false;
        }    

        if (!string.IsNullOrEmpty(currentFP.study_status)
        && (currentFP.study_status.Contains("16") || currentFP.study_status.Contains("21")))
        {
            return false;
        }

        if (!string.IsNullOrEmpty(currentFP.phase)
        && (currentFP.phase.Contains("110") || currentFP.phase.Contains("115")))
        {
            return false;
        }

        if (!string.IsNullOrEmpty(currentFP.alloc)
        && (currentFP.alloc.Contains("205") || currentFP.alloc.Contains("210")))
        {
            return false;
        }

        if (!string.IsNullOrEmpty(currentFP.objects)
        && (currentFP.objects.Contains("28") || currentFP.objects.Contains("11")))
        {
            return false;
        }

        return true;
    }


    private void UpdateIndicator (int record_count, int bucket = 0, int baseset_count = 0)
    {
        rec_num_indicator = $"{record_count} Record";
        rec_num_indicator += record_count == 1 ? "" : "s";
        rec_num_indicator += $" found"; 

        if (bucket > 0)
        {
            rec_num_indicator += $", from { bucket} bucket";
            rec_num_indicator += bucket == 1 ? "" : "s";
            rec_num_indicator += $" - {baseset_count} records loaded";

            int percent_done = bucket * 5;
        }
        StateHasChanged();
    }


    private void ShowRange(Tuple<int, int> t)
    {
        PageSet = ShowSet?.GetRange(t.Item1, t.Item2);
    }

    private void ClearFilters()
    {
        Console.WriteLine("boo - I am still clearing filters");
    }

    private void ClearSearch()
    {
        Console.WriteLine("boo - I am still clearing searches");
    }

    private void RemoveUnchecked()
    {
        Console.WriteLine("boo - I am still removing the unchecked");
    }


    private void RecalculateSearchFeedback()
    {
        // Provide the text for the 'SQL area' - Development only

        if (searchType == 1)
        {
            search_url_fb = $"{search_url_stem}/BySearch/{search_scope}/{searchParamsValue}/bucket/has_1000/";
        }

        if (searchType == 2)
        {
            search_url_fb = $"{search_url_stem}/ByRegId/{idType}/{searchParamsValue}";
        }

        if (searchType == 3)
        {
            search_url_fb = $"{search_url_stem}/ByPMID/{searchParamsValue}";
        }
    }

    private bool CheckSearchSQL()
    {
        bool result = true; 

        // Checks that the parameters are OK, or at least plausible

        if (searchType == 1)
        {
            // if search is using text then either a string of more than one letter 
            // or a filter parameters object with at least one filter applied should be
            // entered into the box ....            

            string? search_pars = searchParamsValue?.Trim();
            if (string.IsNullOrEmpty(search_pars))
            {
                if (!currentFP.has_any)
                {
                    string fb_message = "search parameters or filters must be entered";
                    result = false;
                }
            }
        }

        // If search is using an Id then a value must be entered into the box

        if (searchType == 2)
        {
            string? sid = searchParamsValue?.Trim(); ;
            if (string.IsNullOrEmpty(sid) || sid.Length < 4)
            {
                string fb_message = "The identifier must have at least 4 characters";
                result = false;
            }
        }

        // if search is using PMID then an integer should be in the box

        if (searchType == 3)
        {
            string? pmid = searchParamsValue?.Trim(); ;
            if (pmid is null || !int.TryParse(pmid, out int _))
            {
                string fb_message = "The PMID input must be an integer";
                result = false;
            }

        }
        return result;

    }


    private string ProcessSearchParams(string in_pars)
    {
        if (string.IsNullOrEmpty(in_pars))
        {
            return "ALL STUDIES";
        }

        string new_st = in_pars.ToLower() + " ";  // ' ' added to catch final numbers and 'a's below
        new_st = new_st.Replace("'", "");      // simplifies things
        new_st = new_st.Replace("‘", "");
        new_st = new_st.Replace("’", "");
        new_st = new_st.Replace(".", "");      // simplifies things
        new_st = new_st.Replace("/", " ");     // split these words up
        new_st = new_st.Replace("  ", " ");    // makes comparisons below safer

        if (new_st.Contains(" in ") || new_st.StartsWith("in "))
        {
            new_st = new_st.Replace("in situ", "insitu");
            new_st = new_st.Replace("in vivo", "invivo");
            new_st = new_st.Replace("in vitro", "invitro");
            new_st = new_st.Replace("in silico", "insilico");
            new_st = new_st.Replace("in utero", "inutero");
        }
        if (new_st.Contains(" a "))
        {
            new_st = new_st.Replace("hepatitis a ", "hepatitis-a ");
            new_st = new_st.Replace("influenza a ", "influenza-a ");
            new_st = new_st.Replace("philia a ", "philia-a ");
            new_st = new_st.Replace("globin a ", "globin-a ");
            new_st = new_st.Replace("virus a ", "virus-a ");
            new_st = new_st.Replace("protein a ", "protein-a ");
            new_st = new_st.Replace("group a ", "group-a ");
            new_st = new_st.Replace("type a ", "type-a ");
            new_st = new_st.Replace("vitamin a ", "vitamin-a ");
            new_st = new_st.Replace("factor a ", "factor-a ");
            new_st = new_st.Replace("family a ", "family-a ");
            new_st = new_st.Replace("coenzyme a ", "coenzyme-a ");
            new_st = new_st.Replace("kinase a ", "kinase-a ");
            new_st = new_st.Replace("ferase a ", "ferase-a ");
            new_st = new_st.Replace("tidase a ", "tidase-a ");
            new_st = new_st.Replace("tidases a ", "tidases-a ");
            new_st = new_st.Replace("kinin a ", "kinin-a ");
        }
        if (new_st.Contains(" term "))
        {
            new_st = new_st.Replace("short term ", "short-term ");
            new_st = new_st.Replace("medium term ", "medium-term ");
            new_st = new_st.Replace("long term ", "long-term ");
        }
        if (Regex.IsMatch(new_st, @" \d{1,2} "))
        {
            while (Regex.IsMatch(new_st, @" \d{1,2} "))   // may be more than one
            {
                string to_replace = Regex.Match(new_st, @" \d{1,2} ").Value;
                string new_value;
                if (Regex.IsMatch(new_st, @" \d{1,2} mg"))
                {
                    new_value = to_replace[..^1]; // may be a dosage figure, usually mg;
                }
                else
                {
                    new_value = to_replace[1..];  // more often a suffix
                }
                new_st = new_st.Replace(to_replace, new_value);
            }
        }
        if (Regex.IsMatch(new_st, @" (?=[xvi])(x{0,2})(i[xv]|v?i{0,3}) "))
        {
            while (Regex.IsMatch(new_st, @" (?=[xvi])(x{0,2})(i[xv]|v?i{0,3}) "))
            {
                string to_replace = Regex.Match(new_st, @" (?=[xvi])(x{0,2})(i[xv]|v?i{0,3}) ").Value;
                string new_value = roman_suffixes[to_replace];
                new_st = new_st.Replace(to_replace, new_value);
            }
        }
        if (new_st.Contains("phase "))   // some phase types not picked up above
        {
            new_st = new_st.Replace("phase 1a ", "phase1a ");
            new_st = new_st.Replace("phase 1b ", "phase1b ");
            new_st = new_st.Replace("phase 1/2 ", "phase12 ");
            new_st = new_st.Replace("phase i/ii ", "phase12 ");
            new_st = new_st.Replace("phase 2/3 ", "phase23 ");
            new_st = new_st.Replace("phase ii/iii ", "phase23 ");
            new_st = new_st.Replace("phase 2a ", "phase2a ");
            new_st = new_st.Replace("phase 2b ", "phase2b ");
            new_st = new_st.Replace("phase 3/4 ", "phase34 ");
            new_st = new_st.Replace("phase iii/iv ", "phase34 ");
        }

        return new_st.Trim();
 
    }


    private void RecalcFilterFeedback()
    {
        string fb_string = "";
        fb_string += type_fback == "" ? "" : " AND " + type_fback;
        fb_string += status_fback == "" ? "" : " AND " + status_fback;
        fb_string += year_fback == "" ? "" : " AND " + year_fback;
        fb_string += country_fback == "" ? "" : " AND " + country_fback;
        fb_string += object_fback == "" ? "" : " AND HAS " + object_fback;
        fb_string += phase_fback == "" ? "" : " AND " + phase_fback;
        fb_string += alloc_fback == "" ? "" : " AND " + alloc_fback;
        filter_fback = fb_string == "" ? "" : fb_string[5..];
        if (filter_fback == "")
        {
            filter_fback = "None applied";
        }
        StateHasChanged();
    }

    private void updateTypeFBack(string fback)
    {
        type_fback = fback;  RecalcFilterFeedback();
    }

    private void updateStatusFBack(string fback)
    {
        status_fback = fback; RecalcFilterFeedback(); 
    }

    private void updateYearFBack(string fback)
    {
        year_fback = fback; RecalcFilterFeedback();
    }

    private void updateCountryList(List<Country> countriesSelected)
    {
        string sqlparams = ""; string fback = "";
        string country_sql = ""; country_fback = "";
        if (countriesSelected?.Any() == true)
        {
            foreach (Country c in countriesSelected)
            {
                fback += ", " + c.name;
                sqlparams += ", " + c.id.ToString();
            }
            country_fback = $"countries one of ({fback[2..]})";
            country_sql = $"({sqlparams[2..]})";
        }
        currentFP.countries = country_sql;
        currentFP.countries_num = country_sql == "" ? 0 : currentFP.countries.Split(',').Length; ;

        RecalcFilterFeedback();
        RecalcFilterSQL();
    }

    private void updateObjectFBack(string fback)
    {
        object_fback = fback; RecalcFilterFeedback();
    }

    private void updatePhaseFBack(string fback)
    {
        phase_fback = fback; RecalcFilterFeedback();
    }

    private void updateAllocFBack(string fback)
    {
        alloc_fback = fback; RecalcFilterFeedback();
    }


    private void RecalcFilterSQL()
    {
        string sql_string = "";
        sql_string += currentFP.study_type_num == 0 ? "" : $", Type [{currentFP.study_type_num}] : {currentFP.study_type}";
        sql_string += currentFP.study_status_num == 0 ? "" : $", Status [{currentFP.study_status_num}] : {currentFP.study_status}";
        sql_string += currentFP.start_year_num == 0 ? "" : $", Year [{currentFP.start_year_num}] : {currentFP.start_year}";
        sql_string += currentFP.countries_num == 0 ? "" : $", Location [{currentFP.countries_num}] : {currentFP.countries}";
        sql_string += currentFP.objects_num == 0 ? "" : $", Objects [{currentFP.objects_num}] :{currentFP.objects}";
        sql_string += currentFP.phase_num == 0 ? "" : $", Phase [{currentFP.phase_num}] : {currentFP.phase}";
        sql_string += currentFP.alloc_num == 0 ? "" : $", Alloc [{currentFP.alloc_num}] : {currentFP.alloc}";

        currentFP.has_any = currentFP.study_type_num > 0 || currentFP.study_status_num > 0 || currentFP.start_year_num > 0
              || currentFP.countries_num > 0 || currentFP.objects_num > 0 || currentFP.phase_num > 0 || currentFP.alloc_num > 0;

        filter_sql = sql_string == "" ? "" : "WITH " + sql_string[2..];
        StateHasChanged();
    }


    private int GetEntryNum(string filter_sql)
    {
        int leftB_pos = filter_sql.IndexOf('(');
        string values_string = filter_sql[leftB_pos..];
        return values_string.Split(',').Length;
    }

    private int GetSimpleEntryNum(string filter_sql)
    {
        return filter_sql.Split(',').Length;
    }

    private void updateTypeSQL(string sql)
    {
        // type_sql a string of the form...
        // 'study_type_id in (11, 16)'

        currentFP.study_type = sql;
        currentFP.study_type_num = sql == "" ? 0 : GetEntryNum(sql);
        RecalcFilterSQL();
    }

    private void updateStatusSQL(string sql)
    {
        currentFP.study_status = sql;
        currentFP.study_status_num = sql == "" ? 0 : GetEntryNum(sql);
        RecalcFilterSQL();
    }

    private void updateYearSQL(string sql)
    {
        currentFP.start_year = sql;
        currentFP.start_year_num = sql == "" ? 0 : currentFP.start_year.Split(',').Length;
        RecalcFilterSQL();

    }

    private void updateObjectSQL(string sql)
    {
        currentFP.objects = sql;
        currentFP.objects_num = sql == "" ? 0 : currentFP.objects.Split(',').Length; ;
        RecalcFilterSQL();
    }

    private void updatePhaseSQL(string sql)
    {
        currentFP.phase = sql;
        currentFP.phase_num = sql == "" ? 0 : GetEntryNum(sql);
        RecalcFilterSQL();
    }

    private void updateAllocSQL(string sql)
    {
        currentFP.alloc = sql;
        currentFP.alloc_num = sql == "" ? 0 : GetEntryNum(sql);
        RecalcFilterSQL();
    }


    List<Option<string>> searchOptions = default!;
    List<Option<string>> idOptions = default!;

    protected override void OnInitialized()
    {
        searchOptions = new()
        {
            { new Option<string> { Value = "1", Text = "Key word(s)", Selected = true } },
            { new Option<string> { Value = "2", Text = "Study identifier"} },
            { new Option<string> { Value = "3", Text = "Paper identifier (PMID)" } }
        };

        idOptions = new()
        {
            { new Option<string> { Value = "11", Text = "Trial registry ID", Selected = true } },
            { new Option<string> { Value = "12", Text = "Ethics Review ID"} },
            { new Option<string> { Value = "13", Text = "Funder’s ID"} },
            { new Option<string> { Value = "14", Text = "Sponsor’s ID" } },
            { new Option<string> { Value = "41", Text = "Regulatory Authority ID" } },
            { new Option<string> { Value = "39", Text = "NIH CTRP ID"} },
            { new Option<string> { Value = "40", Text = "DAIDS ID"} },
            { new Option<string> { Value = "42", Text = "NHBLI ID" } },
            { new Option<string> { Value = "45", Text = "Obsolete NTR number" } },
            { new Option<string> { Value = "45", Text = "CDR Number" } }
        };


        roman_suffixes = new()
        {
            {" i ", "1 "}, {" ii ", "2 "},{" iii ", "3 "},{" iv ", "4 "},{" v ", "5 "},
            {" vi ", "6 "},{" vii ", "7 "},{" viii ", "8 "},{" ix ", "9 "},{" x ", "10 "},
            {" xi ", "11 "}, {" xii ", "12 "},{" xiii ", "13 "},{" xiv ", "14 "},{" xv ", "15 "},
            {" xvi ", "16 "},{" xvii ", "17 "},{" xviii ", "18 "},{" xix ", "19 "},{" xx ", "20 " },
            {" xxi ", "21 "},{" xxii ", "22 "},{" xxiii ", "23 "},{" xxiv ", "24 "},{" xxv ", "25 " },
            {" xxvi ", "26 "},{" xxvii ", "27 "},{" xxviii ", "28 "},
            {" xxix ", "29 "},{" xxx ", "30 " }
        };
    }


    private void SearchOptionChanged(Option<string> s)
    {
        searchText = s?.Text ?? "None";
        searchType = Int32.Parse(s?.Value ?? "0");
        paramsLabelText = searchType switch 
        {
            1 => "Words",
            2 => "Identifier",
            3 => "PubMed ID",
            _ => "Parameters"
        };

        // for now - to make testing easier

        if (searchType == 1)
        {
            searchParamsValue = "brca";
        }

        if (searchType == 2)
        {
            idType = 11;
            searchParamsValue = "NCT01746290";
        }

        if (searchType == 3)
        {

            searchParamsValue = "1017769"; // "1017769"; "462143";
        }

        RecalculateSearchFeedback();
        SearchPossible = CheckSearchSQL();

    }

    private void idOptionChanged(Option<string> s)
    {
        idText = s?.Text ?? "None";
        idType = Int32.Parse(s?.Value ?? "0");
        RecalculateSearchFeedback();
        SearchPossible = CheckSearchSQL();

        // for now - to make testing easier
        if (idType == 11)
        {
            searchParamsValue = "NCT01746290";
        }
        if (idType == 14)
        {
            searchParamsValue = "19.05.CLI";
        }
    }

}
